<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>è¨ªå•çœ‹è­·è¨˜éŒ²</title>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #f0f7f4 0%, #e8f4f0 50%, #f5f9f7 100%); min-height: 100vh; }
    .container { max-width: 720px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { font-size: 24px; font-weight: 700; color: #1a2e28; margin: 0 0 6px 0; }
    .header p { font-size: 13px; color: #6b7c74; margin: 0; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 24px rgba(0, 80, 60, 0.08); padding: 24px; margin-bottom: 16px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #e8f4f0; color: #00816a; border-radius: 20px; font-size: 13px; font-weight: 500; margin-bottom: 16px; }
    .input-group { margin-bottom: 14px; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 500px) { .input-row { grid-template-columns: 1fr; } }
    .input-label { display: block; font-size: 13px; font-weight: 600; color: #3d4f46; margin-bottom: 6px; }
    .input-field { width: 100%; padding: 12px 14px; border: 2px solid #e5ebe8; border-radius: 10px; font-size: 16px; font-family: inherit; -webkit-appearance: none; background: white; }
    .input-field:focus { outline: none; border-color: #00a67d; }
    .input-field:disabled { background: #f5f5f5; color: #999; }
    .input-hint { font-size: 11px; color: #8a9a92; margin-top: 4px; }
    .input-error { font-size: 11px; color: #ef4444; margin-top: 4px; display: none; }
    .vital-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (max-width: 400px) { .vital-grid { grid-template-columns: 1fr; } }
    .vital-item { display: flex; align-items: center; gap: 8px; }
    .vital-item label { font-size: 13px; font-weight: 500; color: #3d4f46; min-width: 50px; }
    .vital-item input { flex: 1; padding: 10px 12px; border: 2px solid #e5ebe8; border-radius: 8px; font-size: 16px; text-align: right; max-width: 100px; }
    .vital-item input:focus { outline: none; border-color: #00a67d; }
    .vital-item .unit { font-size: 13px; color: #6b7c74; min-width: 45px; }
    .bp-input { display: flex; align-items: center; gap: 4px; flex: 1; }
    .bp-input input { width: 60px; padding: 10px 8px; border: 2px solid #e5ebe8; border-radius: 8px; font-size: 16px; text-align: center; }
    .bp-input input:focus { outline: none; border-color: #00a67d; }
    .bp-input span { color: #6b7c74; font-weight: 500; }
    .vital-full-row { grid-column: 1 / -1; }
    .record-section { text-align: center; padding: 20px 0; }
    .record-btn { width: 130px; height: 130px; border-radius: 50%; border: none; cursor: pointer; position: relative; display: inline-flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; background: linear-gradient(145deg, #00a67d, #008f6b); box-shadow: 0 8px 32px rgba(0, 166, 125, 0.35); transition: all 0.3s; }
    .record-btn:active { transform: scale(0.96); }
    .record-btn.recording { background: linear-gradient(145deg, #ef4444, #dc2626); box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4); animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .mic-icon { width: 44px; height: 44px; fill: white; }
    .btn-text { color: white; font-size: 13px; font-weight: 600; }
    .timer { font-size: 12px; color: rgba(255,255,255,0.9); font-weight: 500; display: none; }
    .record-hint { font-size: 12px; color: #8a9a92; margin: 0; }
    .textarea { width: 100%; min-height: 120px; padding: 14px; border: 2px solid #e5ebe8; border-radius: 12px; font-size: 15px; line-height: 1.6; resize: vertical; font-family: inherit; }
    .textarea:focus { outline: none; border-color: #00a67d; }
    .button-group { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .action-btn { padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 6px; font-family: inherit; }
    .primary-btn { background: linear-gradient(145deg, #00a67d, #008f6b); color: white; box-shadow: 0 4px 16px rgba(0, 166, 125, 0.25); }
    .primary-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .secondary-btn { background: #f3f7f5; color: #4a5a52; border: 2px solid #e5ebe8; }
    .error-box { background: #fef2f2; border: 2px solid #fecaca; color: #b91c1c; padding: 12px 16px; border-radius: 10px; font-size: 13px; margin-bottom: 14px; display: none; }
    .success-box { background: #d1fae5; border: 2px solid #10b981; color: #065f46; padding: 16px; border-radius: 12px; margin-bottom: 16px; text-align: center; }
    .success-box h3 { margin: 0 0 8px 0; font-size: 16px; }
    .success-box p { margin: 0; font-size: 13px; }
    .review-box { background: #fffbeb; border: 2px solid #f59e0b; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .review-title { font-weight: 600; color: #92400e; margin-bottom: 8px; }
    .info-row { display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: #4a5a52; margin-bottom: 12px; }
    .info-row span { font-weight: 600; }
    .vital-display { background: #f0f7f4; border-radius: 8px; padding: 10px 14px; margin-bottom: 12px; font-size: 13px; }
    .editable-record { width: 100%; min-height: 150px; padding: 14px; border: 2px solid #d4e5dd; border-radius: 12px; font-size: 14px; line-height: 1.7; font-family: inherit; background: #f8faf9; resize: vertical; }
    .editable-record:focus { outline: none; border-color: #00a67d; background: white; }
    .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; flex-direction: column; z-index: 1000; }
    .spinner { width: 50px; height: 50px; border: 4px solid #e5ebe8; border-top-color: #00a67d; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ è¨ªå•çœ‹è­·è¨˜éŒ²</h1>
      <p>éŸ³å£°å…¥åŠ›ã§ã‹ã‚“ãŸã‚“è¨˜éŒ²ä½œæˆ</p>
    </div>

    <div id="step-input">
      <div class="card">
        <div class="badge">ğŸ‘¤ åŸºæœ¬æƒ…å ±</div>
        <div class="input-row">
          <div class="input-group">
            <label class="input-label">è¨ªå•æ—¥</label>
            <input type="date" id="visitDate" class="input-field">
          </div>
          <div class="input-group">
            <label class="input-label">åˆ©ç”¨è€…åï¼ˆã‚«ãƒŠï¼‰</label>
            <input type="text" id="patientName" class="input-field" placeholder="ãƒ¤ãƒãƒ€ã‚¿ãƒ­ã‚¦">
            <div class="input-hint">ã‚«ã‚¿ã‚«ãƒŠãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãªã—ã§å…¥åŠ›</div>
            <div id="patientNameError" class="input-error">ã‚«ã‚¿ã‚«ãƒŠã®ã¿ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        <div class="input-row" style="margin-top:14px">
          <div class="input-group">
            <label class="input-label">è·ç¨®</label>
            <select id="jobType" class="input-field">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="çœ‹è­·å¸«">çœ‹è­·å¸«</option>
              <option value="ãƒªãƒãƒ“ãƒªè·">ãƒªãƒãƒ“ãƒªè·</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">è¨˜éŒ²è€…</label>
            <select id="recorderName" class="input-field" disabled>
              <option value="">å…ˆã«è·ç¨®ã‚’é¸æŠ</option>
            </select>
          </div>
        </div>
        <div class="input-row" style="margin-top:14px">
          <div class="input-group">
            <label class="input-label">è¨ªå•é–‹å§‹æ™‚é–“</label>
            <input type="time" id="visitStartTime" class="input-field" onchange="calculateEndTime()">
          </div>
          <div class="input-group">
            <label class="input-label">è¨ªå•æ™‚é–“</label>
            <select id="visitDuration" class="input-field" onchange="calculateEndTime()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="30">30åˆ†</option>
              <option value="40">40åˆ†</option>
              <option value="60">60åˆ†</option>
              <option value="90">90åˆ†</option>
            </select>
          </div>
        </div>
        <div class="input-row" style="margin-top:14px">
          <div class="input-group">
            <label class="input-label">è¨ªå•çµ‚äº†æ™‚é–“ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
            <input type="text" id="visitEndTime" class="input-field" readonly style="background:#f5f5f5">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="badge">ğŸ’“ ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</div>
        <div class="vital-grid">
          <div class="vital-item">
            <label>ä½“æ¸©</label>
            <input type="number" id="vitalTemp" step="0.1" placeholder="36.5" inputmode="decimal">
            <span class="unit">â„ƒ</span>
          </div>
          <div class="vital-item">
            <label>è„ˆæ‹</label>
            <input type="number" id="vitalPulse" placeholder="72" inputmode="numeric">
            <span class="unit">å›/åˆ†</span>
          </div>
          <div class="vital-item vital-full-row">
            <label>è¡€åœ§</label>
            <div class="bp-input">
              <input type="number" id="vitalBpHigh" placeholder="120" inputmode="numeric">
              <span>/</span>
              <input type="number" id="vitalBpLow" placeholder="80" inputmode="numeric">
            </div>
            <span class="unit">mmHg</span>
          </div>
          <div class="vital-item">
            <label>SpO2</label>
            <input type="number" id="vitalSpo2" placeholder="98" inputmode="numeric">
            <span class="unit">%</span>
          </div>
          <div class="vital-item">
            <label>ä½“é‡</label>
            <input type="number" id="vitalWeight" step="0.1" placeholder="55.0" inputmode="decimal">
            <span class="unit">kg</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="record-section">
          <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
            <svg id="micIcon" class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2" fill="none" stroke="white" stroke-width="2"/>
              <line x1="12" y1="19" x2="12" y2="23" stroke="white" stroke-width="2"/>
              <line x1="8" y1="23" x2="16" y2="23" stroke="white" stroke-width="2"/>
            </svg>
            <svg id="stopIcon" class="mic-icon hidden" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
            <span id="btnText" class="btn-text">éŒ²éŸ³é–‹å§‹</span>
            <span id="timerText" class="timer">00:00</span>
          </button>
          <p id="recordHint" class="record-hint">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„</p>
        </div>
      </div>

      <div class="card">
        <div class="badge">ğŸ“ éŸ³å£°èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ</div>
        <div id="errorBox" class="error-box"></div>
        <textarea id="transcript" class="textarea" placeholder="éŸ³å£°å…¥åŠ›ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
        <div class="button-group">
          <button id="generateBtn" class="action-btn primary-btn" onclick="generateRecord()" disabled>âš¡ è¨˜éŒ²ã‚’ç”Ÿæˆ</button>
          <button class="action-btn secondary-btn" onclick="resetAll()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>

    <div id="step-review" class="hidden">
      <div class="card">
        <div class="review-box">
          <div class="review-title">âš ï¸ è¨˜éŒ²å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
          <div class="info-row">
            <div><span>è¨ªå•æ—¥:</span> <span id="reviewDate"></span></div>
            <div><span>åˆ©ç”¨è€…:</span> <span id="reviewPatient"></span></div>
            <div><span>è·ç¨®:</span> <span id="reviewJobType"></span></div>
            <div><span>è¨˜éŒ²è€…:</span> <span id="reviewRecorder"></span></div>
            <div><span>è¨ªå•æ™‚é–“:</span> <span id="reviewVisitTime"></span></div>
          </div>
          <div class="vital-display" id="reviewVital"></div>
        </div>
        <textarea id="editableRecord" class="editable-record"></textarea>
        <div class="button-group">
          <button class="action-btn primary-btn" onclick="saveRecord()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>
          <button class="action-btn secondary-btn" onclick="copyRecord()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
          <button class="action-btn secondary-btn" onclick="goBack()">â† æˆ»ã‚‹</button>
        </div>
      </div>
    </div>

    <div id="step-saved" class="hidden">
      <div class="card">
        <div class="success-box">
          <h3>âœ… ä¿å­˜ã—ã¾ã—ãŸï¼</h3>
          <p>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ</p>
        </div>
        <button class="action-btn primary-btn" onclick="resetAll()" style="width:100%">â• æ–°ã—ã„è¨˜éŒ²ã‚’ä½œæˆ</button>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loadingText">å‡¦ç†ä¸­...</div>
  </div>

<script>
// â˜…â˜…â˜… ã“ã“ã«GASã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®š â˜…â˜…â˜…
var GAS_URL = 'https://script.google.com/macros/s/AKfycbzc1jdsUV9k2Erlh09GmJGdUyDuRcfNroFOWfrymauLe2GeVo7J16fUWMnMUMhux9bfrQ/exec';

var isRecording = false;
var recognition = null;
var recordingTimer = null;
var recordingSeconds = 0;
var accumulatedTranscript = '';
var staffList = [];

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('patientName').addEventListener('input', validatePatientName);
  document.getElementById('transcript').addEventListener('input', updateGenerateButton);
  document.getElementById('jobType').addEventListener('change', onJobTypeChange);
  document.getElementById('recorderName').addEventListener('change', updateGenerateButton);
  loadStaffList();
});

function loadStaffList() {
  if (GAS_URL === 'YOUR_GAS_DEPLOY_URL_HERE') {
    console.log('GAS_URL not configured');
    return;
  }
  fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'getStaff' }) })
    .then(function(r) { return r.text(); })
    .then(function(t) {
      var result = JSON.parse(t);
      if (result.success && result.data) staffList = result.data.staff || [];
    })
    .catch(function(e) { console.error(e); });
}

function onJobTypeChange() {
  var jobType = document.getElementById('jobType').value;
  var select = document.getElementById('recorderName');
  select.innerHTML = '';
  if (!jobType) {
    select.innerHTML = '<option value="">å…ˆã«è·ç¨®ã‚’é¸æŠ</option>';
    select.disabled = true;
    updateGenerateButton();
    return;
  }
  var filtered = staffList.filter(function(s) { return s.jobType === jobType; });
  if (filtered.length === 0) {
    select.innerHTML = '<option value="">è©²å½“è€…ãªã—</option>';
    select.disabled = true;
  } else {
    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    filtered.forEach(function(s) {
      var opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = s.name;
      select.appendChild(opt);
    });
    select.disabled = false;
  }
  updateGenerateButton();
}

function validatePatientName() {
  var input = document.getElementById('patientName');
  var error = document.getElementById('patientNameError');
  var value = input.value.replace(/[\sã€€]/g, '');
  input.value = value;
  var valid = /^[ã‚¡-ãƒ¶ãƒ¼]*$/.test(value);
  error.style.display = (value && !valid) ? 'block' : 'none';
  updateGenerateButton();
  return valid || !value;
}

function updateGenerateButton() {
  var transcript = document.getElementById('transcript').value.trim();
  var patientName = document.getElementById('patientName').value.trim();
  var jobType = document.getElementById('jobType').value;
  var recorder = document.getElementById('recorderName').value;
  var valid = /^[ã‚¡-ãƒ¶ãƒ¼]*$/.test(patientName);
  document.getElementById('generateBtn').disabled = !transcript || !patientName || !jobType || !recorder || !valid;
}

function toggleRecording() {
  if (isRecording) stopRecording();
  else startRecording();
}

function startRecording() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    return;
  }
  var isAndroid = /Android/i.test(navigator.userAgent);
  
  function createRecognition() {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    var rec = new SpeechRecognition();
    rec.lang = 'ja-JP';
    rec.continuous = true;
    rec.interimResults = !isAndroid;
    var sessionTranscript = '';
    var lastResultIndex = 0;
    
    rec.onresult = function(event) {
      var interim = '';
      for (var i = lastResultIndex; i < event.results.length; i++) {
        var result = event.results[i];
        if (result.isFinal) {
          sessionTranscript += result[0].transcript;
          lastResultIndex = i + 1;
        } else if (!isAndroid) {
          interim = result[0].transcript;
        }
      }
      document.getElementById('transcript').value = accumulatedTranscript + sessionTranscript + interim;
      updateGenerateButton();
    };
    
    rec.onerror = function(event) {
      if (event.error === 'not-allowed') {
        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
        stopRecording();
      }
    };
    
    rec.onend = function() {
      if (isRecording) {
        accumulatedTranscript = document.getElementById('transcript').value;
        recognition = createRecognition();
        recognition.start();
      }
    };
    
    return rec;
  }
  
  accumulatedTranscript = document.getElementById('transcript').value;
  recognition = createRecognition();
  recognition.start();
  isRecording = true;
  recordingSeconds = 0;
  
  var btn = document.getElementById('recordBtn');
  btn.classList.add('recording');
  document.getElementById('micIcon').classList.add('hidden');
  document.getElementById('stopIcon').classList.remove('hidden');
  document.getElementById('btnText').textContent = 'åœæ­¢';
  document.getElementById('timerText').style.display = 'block';
  document.getElementById('recordHint').textContent = 'è©±ã—ã¦ãã ã•ã„...';
  
  recordingTimer = setInterval(function() {
    recordingSeconds++;
    var m = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
    var s = (recordingSeconds % 60).toString().padStart(2, '0');
    document.getElementById('timerText').textContent = m + ':' + s;
  }, 1000);
}

function stopRecording() {
  if (recognition) { recognition.stop(); recognition = null; }
  isRecording = false;
  if (recordingTimer) { clearInterval(recordingTimer); recordingTimer = null; }
  
  var btn = document.getElementById('recordBtn');
  btn.classList.remove('recording');
  document.getElementById('micIcon').classList.remove('hidden');
  document.getElementById('stopIcon').classList.add('hidden');
  document.getElementById('btnText').textContent = 'éŒ²éŸ³é–‹å§‹';
  document.getElementById('timerText').style.display = 'none';
  document.getElementById('recordHint').textContent = 'ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„';
}

function calculateEndTime() {
  var startTime = document.getElementById('visitStartTime').value;
  var duration = document.getElementById('visitDuration').value;
  var endTimeField = document.getElementById('visitEndTime');
  
  if (!startTime || !duration) {
    endTimeField.value = '';
    return;
  }
  
  var parts = startTime.split(':');
  var startDate = new Date();
  startDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
  
  var endDate = new Date(startDate.getTime() + parseInt(duration) * 60000);
  var endHours = endDate.getHours().toString().padStart(2, '0');
  var endMinutes = endDate.getMinutes().toString().padStart(2, '0');
  
  endTimeField.value = endHours + ':' + endMinutes;
}

function getVitalData() {
  return {
    temp: document.getElementById('vitalTemp').value,
    bpHigh: document.getElementById('vitalBpHigh').value,
    bpLow: document.getElementById('vitalBpLow').value,
    pulse: document.getElementById('vitalPulse').value,
    spo2: document.getElementById('vitalSpo2').value,
    weight: document.getElementById('vitalWeight').value
  };
}

function generateRecord() {
  var transcript = document.getElementById('transcript').value.trim();
  var jobType = document.getElementById('jobType').value;
  var vital = getVitalData();
  
  var vitalText = '';
  if (vital.temp) vitalText += 'ä½“æ¸©' + vital.temp + 'åº¦ã€';
  if (vital.bpHigh && vital.bpLow) vitalText += 'è¡€åœ§' + vital.bpHigh + 'ã®' + vital.bpLow + 'ã€';
  if (vital.pulse) vitalText += 'è„ˆæ‹' + vital.pulse + 'å›ã€';
  if (vital.spo2) vitalText += 'SPO2 ' + vital.spo2 + '%ã€';
  if (vital.weight) vitalText += 'ä½“é‡' + vital.weight + 'ã‚­ãƒ­ã€';
  
  showLoading('è¨˜éŒ²ã‚’ç”Ÿæˆä¸­...');
  
  fetch(GAS_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'generate', transcript: vitalText + transcript, jobType: jobType })
  })
  .then(function(r) { return r.text(); })
  .then(function(t) {
    hideLoading();
    var result = JSON.parse(t);
    if (result.success && result.data) showReviewStep(result.data.record);
    else showError(result.message || 'ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  })
  .catch(function(e) { hideLoading(); showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e); });
}

function showReviewStep(record) {
  var vital = getVitalData();
  var startTime = document.getElementById('visitStartTime').value;
  var endTime = document.getElementById('visitEndTime').value;
  
  document.getElementById('reviewDate').textContent = document.getElementById('visitDate').value;
  document.getElementById('reviewPatient').textContent = document.getElementById('patientName').value;
  document.getElementById('reviewJobType').textContent = document.getElementById('jobType').value;
  document.getElementById('reviewRecorder').textContent = document.getElementById('recorderName').value;
  document.getElementById('reviewVisitTime').textContent = (startTime && endTime) ? startTime + ' ã€œ ' + endTime : 'æœªå…¥åŠ›';
  
  var vitalText = [];
  if (vital.temp) vitalText.push('ä½“æ¸©:' + vital.temp + 'â„ƒ');
  if (vital.bpHigh && vital.bpLow) vitalText.push('è¡€åœ§:' + vital.bpHigh + '/' + vital.bpLow);
  if (vital.pulse) vitalText.push('è„ˆæ‹:' + vital.pulse);
  if (vital.spo2) vitalText.push('SpO2:' + vital.spo2 + '%');
  if (vital.weight) vitalText.push('ä½“é‡:' + vital.weight + 'kg');
  document.getElementById('reviewVital').textContent = vitalText.join(' | ') || 'æœªå…¥åŠ›';
  
  document.getElementById('editableRecord').value = record;
  document.getElementById('step-input').classList.add('hidden');
  document.getElementById('step-review').classList.remove('hidden');
}

function saveRecord() {
  var vital = getVitalData();
  var startTime = document.getElementById('visitStartTime').value;
  var endTime = document.getElementById('visitEndTime').value;
  
  showLoading('ä¿å­˜ä¸­...');
  
  fetch(GAS_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'save',
      date: document.getElementById('visitDate').value,
      patientName: document.getElementById('patientName').value,
      jobType: document.getElementById('jobType').value,
      recorderName: document.getElementById('recorderName').value,
      startTime: startTime,
      endTime: endTime,
      record: document.getElementById('editableRecord').value,
      vital: vital
    })
  })
  .then(function(r) { return r.text(); })
  .then(function(t) {
    hideLoading();
    var result = JSON.parse(t);
    if (result.success) {
      document.getElementById('step-review').classList.add('hidden');
      document.getElementById('step-saved').classList.remove('hidden');
    } else {
      alert(result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  })
  .catch(function(e) { hideLoading(); alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e); });
}

function copyRecord() {
  var record = document.getElementById('editableRecord').value;
  navigator.clipboard.writeText(record).then(function() { alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
}

function goBack() {
  document.getElementById('step-review').classList.add('hidden');
  document.getElementById('step-input').classList.remove('hidden');
}

function resetAll() {
  document.getElementById('patientName').value = '';
  document.getElementById('transcript').value = '';
  document.getElementById('jobType').value = '';
  document.getElementById('recorderName').innerHTML = '<option value="">å…ˆã«è·ç¨®ã‚’é¸æŠ</option>';
  document.getElementById('recorderName').disabled = true;
  document.getElementById('visitStartTime').value = '';
  document.getElementById('visitDuration').value = '';
  document.getElementById('visitEndTime').value = '';
  document.getElementById('vitalTemp').value = '';
  document.getElementById('vitalBpHigh').value = '';
  document.getElementById('vitalBpLow').value = '';
  document.getElementById('vitalPulse').value = '';
  document.getElementById('vitalSpo2').value = '';
  document.getElementById('vitalWeight').value = '';
  document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('step-input').classList.remove('hidden');
  document.getElementById('step-review').classList.add('hidden');
  document.getElementById('step-saved').classList.add('hidden');
  document.getElementById('errorBox').style.display = 'none';
  updateGenerateButton();
}

function showLoading(text) {
  document.getElementById('loadingText').textContent = text;
  document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(msg) {
  var box = document.getElementById('errorBox');
  box.textContent = msg;
  box.style.display = 'block';
}
</script>
</body>
</html>
